<!-- =========================================================
  ZENQUENCY HEALING • BALI RETREAT — SECTION 5 (QUICK APPLICATION)
  Connected to GoHighLevel Inbound Webhook (WP-safe binding)
========================================================= -->
<section id="bali-apply"
  aria-label="Quick application form for Bali retreat"
  data-apply-url="/application"
  data-call-url="#book-call"
  data-webhook="https://services.leadconnectorhq.com/hooks/DtSfz1m68vSELOTJJzvc/webhook-trigger/96b13352-35d5-431d-b7d0-d8590f40cca0"
  data-page-interest="Bali Retreat">

  <style>
    /* (Same visual design as before — condensed here for brevity) */
    #bali-apply, #bali-apply * { box-sizing:border-box; }
    #bali-apply{ --ink:#0B6060; --ink-900:#084B4B; --ink-700:#0E7E7E; --muted:#5C6E6E; --accent:#E9C77B; --white:#fff; --sky-25:#F5FBFA; --sky-50:#ECF7F6; --sky-100:#DFF2F0; --sky-200:#CAE7E4; --shadow:0 10px 34px rgba(11,96,96,.12),0 4px 14px rgba(11,96,96,.10); --radius-xl:28px; --radius-lg:18px; --radius-md:14px; --ring:0 0 0 8px rgba(11,96,96,.10); position:relative; isolation:isolate; overflow:clip; padding:clamp(42px,6vw,78px) clamp(18px,5vw,40px); background:radial-gradient(1100px 560px at 14% 12%, rgba(233,199,123,.16), transparent 60%),radial-gradient(900px 520px at 88% 88%, rgba(11,96,96,.10), transparent 60%),linear-gradient(180deg, var(--sky-25), var(--sky-100)); }
    #bali-apply .grain::before{ content:""; position:absolute; inset:-20%; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity=".045"/></svg>'); background-size:160px 160px; pointer-events:none; mix-blend-mode:multiply; }
    .header{ max-width:1040px; margin:0 auto 22px; text-align:center; }
    .eyebrow{ display:inline-flex; gap:10px; align-items:center; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#fff,#ECF7F6); border:1px solid var(--sky-200); color:var(--ink-900); box-shadow:var(--shadow); font:700 12px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; letter-spacing:.3px; }
    .eyebrow .dot{ width:8px; height:8px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 4px rgba(233,199,123,.28); }
    h2{ margin:16px 0 10px; color:var(--ink-900); font:800 clamp(26px,3.3vw,40px)/1.08 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; letter-spacing:-.3px; }
    .subhead{ margin:0 auto; max-width:70ch; color:var(--muted); font:500 clamp(15px,1.6vw,18px)/1.7 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }

    .shell{ max-width:1120px; margin:22px auto 0; display:grid; gap:16px; grid-template-columns:1.15fr .85fr; }
    @media (max-width:980px){ .shell{ grid-template-columns:1fr; } }

    .card{ background:linear-gradient(180deg,#fff,#ECF7F6); border:1px solid var(--sky-200); border-radius:var(--radius-xl); box-shadow:var(--shadow); padding:clamp(16px,2.6vw,22px); }
    .card h3{ margin:0 0 10px; color:var(--ink-900); font:800 18px/1.2 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }

    form{ display:grid; gap:12px; }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    @media (max-width:680px){ .row{ grid-template-columns:1fr; } }
    .field{ position:relative; display:grid; gap:6px; }
    label{ font:800 12.5px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ink-900); }
    input[type="text"],input[type="email"],input[type="tel"],select,textarea{ width:100%; border-radius:12px; border:1px solid var(--sky-200); background:#fff; color:var(--ink-900); box-shadow:var(--shadow); padding:12px 14px; outline:none; font:600 14px/1.4 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; transition: box-shadow .2s ease,border-color .2s ease,transform .12s ease; }
    textarea{ min-height:110px; resize:vertical; }
    input:focus,select:focus,textarea:focus{ border-color:var(--ink-700); box-shadow:var(--ring); }
    .hint{ font:600 11.5px/1.3 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--muted); }
    .error{ font:700 11.5px/1.2 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:#9b1c1c; display:none; }
    .field.invalid .error{ display:block; }

    .choices{ display:flex; flex-wrap:wrap; gap:10px; }
    .chip{ display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; background:#fff; border:1px solid var(--sky-200); border-radius:999px; padding:10px 12px; font:800 12.5px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ink-900); box-shadow:var(--shadow); transition:.2s; }
    .chip[data-checked="true"]{ background:linear-gradient(180deg,var(--ink),var(--ink-900)); color:#fff; box-shadow:0 10px 24px rgba(11,96,96,.18),0 4px 12px rgba(11,96,96,.16); }
    .chip input{ appearance:none; width:0; height:0; position:absolute; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .btn{ -webkit-tap-highlight-color:transparent; appearance:none; border:none; outline:none; cursor:pointer; border-radius:12px; padding:14px 18px; min-width:170px; display:inline-flex; align-items:center; justify-content:center; gap:10px; font:800 14px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; transition:.2s; }
    .btn-primary{ background:linear-gradient(180deg,var(--ink),var(--ink-900)); color:#fff; box-shadow:0 12px 28px rgba(11,96,96,.18),0 4px 12px rgba(11,96,96,.16); }
    .btn-ghost{ background:linear-gradient(180deg,#fff,#ECF7F6); color:var(--ink-900); border:1px solid var(--sky-200); box-shadow:var(--shadow); }
    .btn:focus-visible{ box-shadow:var(--ring); }
    .fine{ font:600 12px/1.4 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--muted); margin-top:6px; }

    .side{ display:grid; gap:14px; align-content:start; }
    .pill{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid var(--sky-200); color:var(--ink-900); box-shadow:var(--shadow); font:800 12px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }
    .pill .gold{ width:10px; height:10px; border-radius:999px; background:var(--accent); }
    .spotmeter{ display:flex; align-items:center; gap:10px; color:var(--ink-900); font:700 12.5px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }
    .meter{ --h:9px; height:var(--h); width:180px; border-radius:999px; background:var(--sky-200); overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.04); }
    .meter > b{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#f0dca3); border-radius:inherit; transition: width .8s cubic-bezier(.2,.75,.2,1); }

    .or{ display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; color:var(--muted); font:800 12px/1 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; margin:8px 0 0; }
    .or::before,.or::after{ content:""; height:1px; background:linear-gradient(90deg, rgba(11,96,96,.12), rgba(11,96,96,.02)); }

    .status{ display:none; margin-top:8px; color:var(--ink-900); font:700 13px/1.4 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }
    .status.show{ display:block; }

    .reveal{ opacity:0; transform:translateY(10px); transition:opacity .5s, transform .5s; }
    .reveal.in{ opacity:1; transform:translateY(0); }
    @media (prefers-reduced-motion:reduce){ #bali-apply *{ transition:none !important; animation:none !important; } }
  </style>

  <div class="grain"></div>

  <div class="header reveal">
    <span class="eyebrow"><span class="dot" aria-hidden="true"></span> Quick Application</span>
    <h2>Two minutes to raise your hand — we’ll follow up with next steps</h2>
    <p class="subhead">Share a few details and choose your interest (5-Day or 7-Day). We’ll confirm availability, share logistics, and guide you to the full application or a short clarity call.</p>
  </div>

  <div class="shell">
    <div class="card reveal" aria-live="polite">
      <h3>Tell us about you</h3>

      <!-- Fallback action so Submit always does something even if JS fails -->
      <form id="apply-form" action="/application" method="GET" novalidate>
        <div class="row">
          <div class="field" id="f-name">
            <label for="name">Full name *</label>
            <input type="text" id="name" name="name" autocomplete="name" placeholder="Your full name" required>
            <div class="error">Please enter your name (min 2 characters).</div>
          </div>
          <div class="field" id="f-email">
            <label for="email">Email *</label>
            <input type="email" id="email" name="email" autocomplete="email" placeholder="you@example.com" required>
            <div class="error">Please enter a valid email address.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="phone">Phone (optional)</label>
            <input type="tel" id="phone" name="phone" autocomplete="tel" placeholder="+1 555 555 5555">
            <div class="hint">We’ll only use this for retreat communication.</div>
          </div>

          <div class="field">
            <label>Interest *</label>
            <div class="choices" role="group" aria-label="Select retreat track">
              <label class="chip" id="opt5" tabindex="0"><input type="radio" name="interest" value="5-Day Healing & Renewal">5-Day</label>
              <label class="chip" id="opt7" tabindex="0"><input type="radio" name="interest" value="7-Day Sound & Energy Mastery Certification">7-Day (Certification)</label>
              <label class="chip" id="optns" tabindex="0"><input type="radio" name="interest" value="Not sure — please guide me">Not sure</label>
            </div>
            <div class="error">Please choose one option.</div>
          </div>
        </div>

        <div class="field">
          <label for="why">Why do you want to join? *</label>
          <textarea id="why" name="why" placeholder="A few sentences about your goals or what you’re seeking." required></textarea>
          <div class="error">Please share a short note (min 12 characters).</div>
        </div>

        <div class="row">
          <div class="field">
            <label for="tz">Time zone</label>
            <select id="tz" name="timezone">
              <option value="">Auto-detected</option>
              <option value="America/Los_Angeles">America/Los_Angeles (PT)</option>
              <option value="America/New_York">America/New_York (ET)</option>
              <option value="Europe/London">Europe/London</option>
              <option value="Europe/Amsterdam">Europe/Amsterdam</option>
              <option value="Asia/Singapore">Asia/Singapore</option>
              <option value="Australia/Sydney">Australia/Sydney</option>
            </select>
            <div class="hint">Helps us suggest call times.</div>
          </div>
          <div class="field">
            <label for="start">When would you like to start?</label>
            <select id="start" name="start">
              <option value="">Choose…</option>
              <option value="0–14 days">0–14 days</option>
              <option value="15–30 days">15–30 days</option>
              <option value="1–3 months">1–3 months</option>
              <option value="Just exploring">Just exploring</option>
            </select>
          </div>
        </div>

        <!-- Honeypot -->
        <div class="field" style="position:absolute; left:-5000px;" aria-hidden="true">
          <label for="company">Company</label>
          <input type="text" id="company" name="company" tabindex="-1" autocomplete="off">
        </div>

        <!-- Hidden UTM + meta -->
        <input type="hidden" name="utm_source"   id="utm_source">
        <input type="hidden" name="utm_medium"   id="utm_medium">
        <input type="hidden" name="utm_campaign" id="utm_campaign">
        <input type="hidden" name="utm_content"  id="utm_content">
        <input type="hidden" name="utm_term"     id="utm_term">
        <input type="hidden" name="referrer"     id="referrer">
        <input type="hidden" name="page_interest" id="page_interest">
        <input type="hidden" name="timestamp"     id="ts">

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="btn-submit">Submit Application</button>
          <a class="btn btn-ghost" id="btn-call" href="#book-call">Prefer a call? Book 15-min</a>
        </div>
        <div class="fine">By submitting, you agree to be contacted about this retreat. We respect your time and inbox.</div>
        <div class="status" id="status">Submitting… please wait.</div>
      </form>
    </div>

    <aside class="card side reveal" aria-label="Availability and quick links">
      <h3>Availability & quick links</h3>
      <div class="pill"><span class="gold"></span> Intimate cohort (max 8)</div>
      <div class="spotmeter">
        <div class="meter" aria-label="Estimated spots filled"><b id="spots-bar"></b></div>
        <span id="spots-text">Checking availability…</span>
      </div>
      <div class="pill"><span class="gold"></span> Deposit: $750 (non-refundable)</div>
      <div class="pill"><span class="gold"></span> 5-Day: $3,997 • 7-Day: $5,997</div>
      <div class="pill"><span class="gold"></span> Location: Ubud, Bali</div>
      <div class="or">or</div>
      <a class="btn btn-ghost" id="side-call" href="#book-call" style="margin-top:6px;">Book a Clarity Call</a>
      <div class="fine">We’ll email logistics and next steps after your application or call booking.</div>
    </aside>
  </div>

  <script>
    (function(){
      // Bind to the section this script lives in (safe in GHL/WP)
      var root = (function(){
        try { return document.currentScript.closest('section#bali-apply') || document.getElementById('bali-apply'); }
        catch(e){ return document.getElementById('bali-apply'); }
      })();
      if(!root){ console.warn('[Bali Apply] Section not found'); return; }

      const $  = (s, c=root)=> c.querySelector(s);
      const $$ = (s, c=root)=> Array.from(c.querySelectorAll(s));
      const MIN_WHY = 12;

      /* Reveal */
      try{
        const obs = new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('in'); obs.unobserve(e.target); } }); }, { threshold:.18 });
        $$('.reveal').forEach(el=> obs.observe(el));
      }catch(e){}

      /* Links & settings */
      const APPLY_URL = root.getAttribute('data-apply-url') || '/application';
      const CALL_URL  = root.getAttribute('data-call-url')  || '#book-call';
      const WEBHOOK   = root.getAttribute('data-webhook')   || '';
      const INTEREST  = root.getAttribute('data-page-interest') || 'Bali Retreat';
      $('#btn-call').href  = CALL_URL;
      $('#side-call').href = CALL_URL;
      const form = $('#apply-form');
      if(form) form.setAttribute('action', APPLY_URL);

      /* UTM/meta */
      function getParam(n){ try{ return new URLSearchParams(window.location.search).get(n) || '';}catch(_){ return ''; } }
      $('#utm_source').value   = getParam('utm_source');
      $('#utm_medium').value   = getParam('utm_medium');
      $('#utm_campaign').value = getParam('utm_campaign');
      $('#utm_content').value  = getParam('utm_content');
      $('#utm_term').value     = getParam('utm_term');
      $('#referrer').value     = document.referrer || '';
      $('#page_interest').value= INTEREST;
      $('#ts').value           = new Date().toISOString();

      /* Timezone (auto-add if not listed) */
      try{
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const sel = $('#tz');
        if(sel && tz && ![...sel.options].some(o=>o.value===tz)){
          sel.insertAdjacentHTML('beforeend', `<option value="${tz}">${tz}</option>`);
        }
      }catch(e){}

      /* Chips */
      const chips = $$('.chip');
      function setChip(id){ chips.forEach(c=>{ const on=c.id===id; c.dataset.checked=on?'true':'false'; const i=c.querySelector('input'); if(i) i.checked=on; }); }
      chips.forEach(c=>{
        c.setAttribute('tabindex','0');
        c.addEventListener('click', ()=> setChip(c.id));
        c.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); c.click(); }});
      });
      setChip('opt5'); // default

      /* LocalStorage */
      const LS_KEY='bali_apply_v1';
      function saveLS(){
        const data={ name:$('#name').value.trim(), email:$('#email').value.trim(), phone:$('#phone').value.trim(), why:$('#why').value.trim(), interest:(chips.find(c=>c.dataset.checked==='true')?.innerText||'') };
        try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch(e){}
      }
      function loadLS(){
        try{
          const raw=localStorage.getItem(LS_KEY); if(!raw) return;
          const d=JSON.parse(raw);
          if(d.name) $('#name').value=d.name;
          if(d.email) $('#email').value=d.email;
          if(d.phone) $('#phone').value=d.phone;
          if(d.why) $('#why').value=d.why;
          if(d.interest){ if(/7-Day/.test(d.interest)) setChip('opt7'); else if(/5-Day/.test(d.interest)) setChip('opt5'); else setChip('optns'); }
        }catch(e){}
      }
      loadLS();
      ['#name','#email','#phone','#why'].forEach(s=> $(s).addEventListener('input', saveLS));

      /* Spots (UX only) */
      const bar=$('#spots-bar'), txt=$('#spots-text');
      function setSpots(t=8,l=8){ const used=Math.max(0,Math.min(t,t-l)); const pct=t?(used/t)*100:0; if(bar){ requestAnimationFrame(()=> bar.style.width=Math.min(100,Math.max(0,pct))+'%'); } if(txt){ if(l<=0) txt.textContent='Waitlist only'; else if(l===1) txt.textContent='1 spot left'; else txt.textContent=`${l} spots available`; } }
      setSpots();

      /* Validation (fixed: no more $(chips[0]) misuse) */
      const hp=$('#company'); let hpTouched=false; if(hp){ hp.addEventListener('input',()=>hpTouched=true); hp.addEventListener('focus',()=>hpTouched=true); }
      const interestField = chips.length ? chips[0].closest('.field') : null;

      function invalidate(el){ const f = typeof el==='string' ? $(el) : el; if(f) f.classList.add('invalid'); }
      function validate(){
        let ok=true;
        const name=$('#name').value.trim(); if(name.length<2){ ok=false; invalidate('#f-name'); } else $('#f-name').classList.remove('invalid');
        const email=$('#email').value.trim(); const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!re.test(email)){ ok=false; invalidate('#f-email'); } else $('#f-email').classList.remove('invalid');
        const picked = root.querySelector('input[name="interest"]:checked');
        if(!picked){ ok=false; interestField && interestField.classList.add('invalid'); } else { interestField && interestField.classList.remove('invalid'); }
        const why=$('#why').value.trim(); if(why.length<MIN_WHY){ ok=false; $('#why').closest('.field').classList.add('invalid'); } else $('#why').closest('.field').classList.remove('invalid');
        const hpVal=hp?hp.value.trim():'';
        if(hpVal && hpTouched){ ok=false; }
        return ok;
      }

      /* Build redirect */
      function buildRedirect(){
        const u=new URL(APPLY_URL, window.location.origin);
        const params={
          name:$('#name').value.trim(),
          email:$('#email').value.trim(),
          phone:$('#phone').value.trim(),
          interest:(root.querySelector('input[name="interest"]:checked')?.value || ''),
          why:$('#why').value.trim(),
          timezone:$('#tz').value || (Intl.DateTimeFormat().resolvedOptions().timeZone || ''),
          start:$('#start').value || '',
          utm_source:$('#utm_source').value, utm_medium:$('#utm_medium').value, utm_campaign:$('#utm_campaign').value,
          utm_content:$('#utm_content').value, utm_term:$('#utm_term').value,
          referrer:$('#referrer').value, page_interest:$('#page_interest').value
        };
        Object.entries(params).forEach(([k,v])=>{ if(v) u.searchParams.set(k,v); });
        return u.toString();
      }

      /* Webhook */
      async function sendWebhook(payload){
        if(!WEBHOOK) return true;
        try{
          console.log('[Bali Apply] POST', WEBHOOK, payload);
          const res=await fetch(WEBHOOK,{ method:'POST', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify(payload) });
          console.log('[Bali Apply] Response', res.status, res.statusText);
          return res.ok;
        }catch(e){ console.warn('[Bali Apply] Webhook error:', e); return false; }
      }

      /* Submit */
      const status=$('#status'); const btn=$('#btn-submit');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();

        if(!validate()){
          status.textContent='Please fix the highlighted fields and try again.'; status.classList.add('show');
          return;
        }

        status.textContent='Submitting… please wait.'; status.classList.add('show');
        btn.disabled=true; btn.style.opacity=.7;

        const fullName=$('#name').value.trim(); const first=fullName.split(' ')[0]||''; const last=fullName.split(' ').slice(1).join(' ')||'';
        const payload={
          name:fullName, first_name:first, last_name:last,
          email:$('#email').value.trim(), phone:$('#phone').value.trim(),
          track:(root.querySelector('input[name="interest"]:checked')?.value || ''),
          intent_note:$('#why').value.trim(),
          timezone:$('#tz').value || (Intl.DateTimeFormat().resolvedOptions().timeZone || ''),
          start:$('#start').value || '',
          tags:['Bali Retreat Lead'],
          utm_source:$('#utm_source').value, utm_medium:$('#utm_medium').value, utm_campaign:$('#utm_campaign').value,
          utm_content:$('#utm_content').value, utm_term:$('#utm_term').value,
          referrer:$('#referrer').value, page_interest:$('#page_interest').value, timestamp:$('#ts').value,
          source:'Website • Bali Quick Application'
        };

        try{ if(window.fbq){ fbq('track','Lead',{content_name:'Bali Retreat Quick Apply'}); } }catch(e){}

        const ok = await sendWebhook(payload);
        if(!ok){ status.textContent='Almost done — redirecting to the full application…'; }
        window.location.href = buildRedirect();
      });

      /* Reduce motion */
      try{ if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) { root.querySelectorAll('*').forEach(el=> el.style.transition='none'); } }catch(e){}
    })();
  </script>
</section>
